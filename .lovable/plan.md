
# Plan: Fix Order Export, Guest Customer Tracking, and Order Number Customization

## Issues Identified

### 1. Order Export Not Working (Incomplete Orders)
**Finding**: The CSV export function in `IncompleteOrdersTab.tsx` appears correctly implemented (lines 227-293). The issue may be browser-related or the download is not triggering properly. Need to verify the export logic and ensure proper error handling.

### 2. Guest Customers Not in Customer List  
**Finding**: The `AdminCustomers.tsx` page only fetches from the `profiles` table (line 99-103). Guest orders have `user_id = NULL` and are never added to profiles since they don't create accounts. The customer list needs to also include guest customers identified by their phone number from orders.

**Current behavior**: Only registered users appear in the customer list.
**Required behavior**: Guest customers (from orders where `user_id IS NULL`) should also appear, identified by their phone number from the shipping address.

### 3. Order Number Not Domain-Based
**Finding**: The order number is generated by a database trigger (`generate_order_number` function) with a hardcoded `PUR-` prefix:
```sql
NEW.order_number = 'PUR-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
```

This needs to be configurable via admin settings and passed from the frontend when creating orders.

---

## Implementation Plan

### Phase 1: Fix Incomplete Order CSV Export

**File**: `src/components/admin/IncompleteOrdersTab.tsx`

Changes:
- Add try-catch wrapper around the export function
- Add better error messaging if no data
- Ensure the Blob download triggers correctly
- Add loading state during export

### Phase 2: Add Guest Customers to Customer List

**File**: `src/pages/admin/AdminCustomers.tsx`

Changes:
- Create a new interface `GuestCustomer` to represent guest customers
- Modify `fetchCustomers` to also query orders with `user_id IS NULL`
- Extract unique phone numbers from shipping addresses of guest orders
- Merge guest customers into the customer list with appropriate metadata
- Add a visual indicator (badge) for guest vs. registered customers
- Allow searching by phone number for both guest and registered customers

**Data Structure for Guest Customers**:
```typescript
interface GuestCustomer {
  id: string;          // Generated from phone hash
  phone: string;       // From shipping_address.phone
  full_name: string;   // From shipping_address.full_name (last used)
  isGuest: true;
  isAdmin: false;
  orderCount: number;
  totalSpent: number;
  created_at: string;  // First order date
}
```

### Phase 3: Add Order Number Customization

#### Step 3a: Update Site Settings Context

**File**: `src/contexts/SiteSettingsContext.tsx`

Add new settings:
```typescript
// Order Number Settings
order_number_prefix: string;        // e.g., "PUR" or custom
order_number_use_domain: boolean;   // Auto-use first 3 letters of domain
```

#### Step 3b: Add Admin UI for Order Number Settings

**File**: `src/pages/admin/AdminSettings.tsx`

Add a new card "Order Settings" with:
- Toggle: "Use domain prefix" (auto-generates prefix from first 3 letters of domain)
- Input: "Custom prefix" (only shown when domain prefix is disabled)
- Preview of order number format

#### Step 3c: Update Order Creation Logic

**Files to update**:
- `src/pages/Checkout.tsx` (line 320)
- `src/components/admin/ConvertOrderDialog.tsx` (line 232)
- `src/components/admin/ManualOrderDialog.tsx`

Changes:
- Read the order prefix from site settings
- If "use domain prefix" is enabled, extract first 3 letters from `window.location.hostname`
- Pass the custom prefix when creating orders
- The database trigger will need to be modified to accept a prefix OR we generate the order number entirely on the frontend

#### Step 3d: Database Changes

**Option A (Recommended)**: Generate order number on frontend and remove trigger dependency on prefix
- The trigger already runs but we can pass the order_number directly
- The trigger only runs if `order_number` is not already set

**Option B**: Modify database function to read prefix from a settings table
- More complex, requires database function changes

**Recommended approach**: Generate order number on frontend with the configured prefix. The current code already does this (line 320 in Checkout.tsx), but the database trigger overrides it. We need to update the trigger to only set order_number if it's NULL.

---

## Technical Details

### Database Migration Required

Update the `generate_order_number` trigger to only set order_number when not provided:

```sql
CREATE OR REPLACE FUNCTION public.generate_order_number()
RETURNS TRIGGER AS $$
BEGIN
  -- Only generate if order_number is not provided
  IF NEW.order_number IS NULL OR NEW.order_number = '' THEN
    NEW.order_number = 'ORD-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || LPAD(FLOOR(RANDOM() * 10000)::TEXT, 4, '0');
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SET search_path = public;
```

### Order Number Generation Helper

Create a utility function:
```typescript
function generateOrderNumber(prefix: string): string {
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const random = Math.floor(1000 + Math.random() * 9000);
  return `${prefix}-${date}-${random}`;
}

function getDomainPrefix(): string {
  const hostname = window.location.hostname;
  // Remove www. and get first part
  const domain = hostname.replace(/^www\./, '').split('.')[0];
  return domain.slice(0, 3).toUpperCase();
}
```

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/components/admin/IncompleteOrdersTab.tsx` | Fix export with error handling |
| `src/pages/admin/AdminCustomers.tsx` | Add guest customer support |
| `src/contexts/SiteSettingsContext.tsx` | Add order number settings |
| `src/pages/admin/AdminSettings.tsx` | Add order settings UI |
| `src/pages/Checkout.tsx` | Use configurable order prefix |
| `src/components/admin/ConvertOrderDialog.tsx` | Use configurable order prefix |
| `src/components/admin/ManualOrderDialog.tsx` | Use configurable order prefix |
| Database migration | Update trigger to respect provided order_number |

---

## Summary

1. **Export Fix**: Add proper error handling and ensure blob download works correctly
2. **Guest Customers**: Query orders with null user_id, group by phone, display in customer list with "Guest" badge
3. **Order Numbers**: 
   - Add admin setting for prefix customization
   - Add toggle for domain-based prefix (first 3 letters of domain)
   - Update all order creation points to use the setting
   - Modify database trigger to not override provided order numbers
